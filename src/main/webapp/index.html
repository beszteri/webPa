<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="style.css" rel="stylesheet">
    <title>Document</title>
</head>
<body>
<div id="login-content" class="content">
    <h1>Login</h1>
    <form id="login-form" onsubmit="return false;">
        <input type="text" name="email"><br>
        <input type="text" name="password"><br>
        <button id="login-button">Login</button><br>
        <button id="guest-button">Guest</button>
    </form>
</div>

<div id="register-content" class="content">
    <h1>Register</h1>
    <form id="register-form" onsubmit="return false;">
        <input type="text" name="email"><br>
        <input type="text" name="password"><br>
        <button id="register-button">Register</button>
    </form>
</div>

<div id="guest-content" class="hidden content">
    <button id="back-to-login-page">Back to login page</button>
</div>

<div id="guest-loaded-content" class="hidden content">
</div>

<div id="welcome-content" class="hidden content">
    <h1>GameShop</h1>
    <button id="mainpage-button" >Main Page</button>
    <button id="games-button" >Load games</button>
    <button id="profile-button" >My profile</button>
    <button id="my-purchases-button">My purchases</button>
    <button id="logout-button">Logout</button>
</div>

<div id="games-content" class="hidden content games"></div>

<div id="profile-content" class="hidden content">
    <button id="change-profile-button">Change profil infos</button>
</div>

<div id="change-profile-infos-content" class="hidden content">
    <br>
    <h2>If you want to update your profile infos, please fill the field below</h2>
    <br>
    <form id="change-profile-infos-form" onsubmit="return false;">
        <input type="text" name="name" placeholder="name"><br>
        <input type="text" name="address" placeholder="address"><br>
        <input type="text" name="phoneNumber" placeholder="phone number"><br>
        <button id="change-profile-infos-button">Change profile infos</button>
    </form>
</div>

<div id="add-to-balance-content" class="hiddent content">
    <form id="add-to-balance-form" onsubmit="return false;">
        <br><br>
        <input type="text" name="balance" placeholder="123456"><br>
        <button id="add-to-balance-button">Add to balance</button>
    </form>
    <button id="actual-balance-button">My actual balance</button>
</div>

<div id="my-purchases-content" class="hidden content">
</div>


<script>

    const OK = 200;
    const BAD_REQUEST = 400;
    const UNAUTHORIZED = 401;
    const NOT_FOUND = 404;
    const INTERNAL_SERVER_ERROR = 500;

    let loginContentDivEl;
    let welcomeContentDivEl;
    let registerContentDivEl;
    let guestContentDivEl;
    let profileContentDivEl;
    let gamesContentDivEl;


    document.addEventListener('DOMContentLoaded', onLoad);

    function onLoad() {
        loginContentDivEl = document.getElementById('login-content');
        welcomeContentDivEl = document.getElementById('welcome-content');
        registerContentDivEl = document.getElementById('register-content');
        profileContentDivEl = document.getElementById('profile-content');
        gamesContentDivEl = document.getElementById('games-content');

        const myPurchasesButtonEl = document.getElementById('my-purchases-button');
        myPurchasesButtonEl.addEventListener('click', onMyPurchasesButtonClicked);

        const addToBalanceButtonEl = document.getElementById('add-to-balance-button');
        addToBalanceButtonEl.addEventListener('click', onAddToBalanceButtonClicked);

        const myActualBalanceButtonEl = document.getElementById('actual-balance-button');
        myActualBalanceButtonEl.addEventListener('click', onActualBalanceButtonClicked);

        const changeProfileButtonEl = document.getElementById('change-profile-infos-button');
        changeProfileButtonEl.addEventListener('click', onChangeProfileInfosButtonClicked);

        const gamesButtonEl = document.getElementById('games-button');
        gamesButtonEl.addEventListener('click', loadGames);

        const backButtonEl = document.getElementById('mainpage-button');
        backButtonEl.addEventListener('click', backToWelcomeScreen);

        const registerButtonEl = document.getElementById('register-button');
        registerButtonEl.addEventListener('click', onRegisterButtonClicked);

        const logoutButtonEl = document.getElementById('logout-button');
        logoutButtonEl.addEventListener('click', onLogoutButtonClicked);

        const profileButtonEl = document.getElementById('profile-button');
        profileButtonEl.addEventListener('click', onProfileButtonClicked);

        const loginButtonEl = document.getElementById('login-button');
        loginButtonEl.addEventListener('click', onLoginButtonClicked);

        const guestButtonEl = document.getElementById('guest-button');
        guestButtonEl.addEventListener('click', onGuestButtonClicked);

        const backToLoginPageButtonEl = document.getElementById('back-to-login-page');
        backToLoginPageButtonEl.addEventListener('click', showLoginScreen);


        getCurrentUser();
        if (hasAuthorization()) {
            onProfileLoad(getCurrentUser());
        } else {
            showContents(['login-content', 'register-content']);
        }
    }

    function onProfileLoad(user) {
        if (user.role === 'ADMIN') {
            showContents(['login-content', 'register-content']);
        } else if (user.role === 'REGISTERED') {
            showContents(['login-content', 'register-content']);
        } else if (user.role === 'UNREGISTERED') {
            showContents(['login-content', 'register-content']);
        }
    }

        function hasAuthorization() {
            const xhr = new XMLHttpRequest();
            xhr.addEventListener('error', onNetworkError);
            xhr.open('GET', 'protected/profile');
            xhr.send();
            if (xhr.status === OK) {
                return true;
            }
        }

        function onGuestButtonClicked() {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', 'games');
            xhr.onload = function () {
                if (this.status == OK) {
                    let games = JSON.parse(this.responseText);
                    let output = '';
                    for (var i in games) {
                        output += '<div id="games-content" class="content games">' +
                            '<img src="' + games[i].imageUrl + '" width="150" height="150">' +
                            '<ul>' +
                            '<li>Name: ' + games[i].name + '</li>' +
                            '<li>Platform: ' + games[i].platform + '</li>' +
                            '<li>Price: ' + games[i].price + '</li>' +
                            '<li><button id="buy-game" content="' + games[i].id + '">Buy game</button> </li>' +
                            '</ul>' +
                            '</div>';
                    }
                    document.getElementById('guest-loaded-content').innerHTML = output;
                }
            }
            showContents(['guest-loaded-content', 'guest-content']);
            xhr.send();
        }

        function showContents(ids) {
            const contentEls = document.getElementsByClassName('content');
            for (let i = 0; i < contentEls.length; i++) {
                const contentEl = contentEls[i];
                if (ids.includes(contentEl.id)) {
                    contentEl.classList.remove('hidden');
                } else {
                    contentEl.classList.add('hidden');
                }
            }
        }
        function showLoginScreen() {
            showContents(['login-content', 'register-content']);
        }

        function getCurrentUser() {
            return JSON.parse(localStorage.getItem('user'));
        }

        function onRegisterButtonClicked() {
            const registerFormEl = document.forms['register-form'];

            const emailInputEl = registerFormEl.querySelector('input[name="email"]');
            const passwordInputEl = registerFormEl.querySelector('input[name="password"]');

            const email = emailInputEl.value;
            const password = passwordInputEl.value;

            const params = new URLSearchParams();
            params.append('email', email);
            params.append('password', password);

            const xhr = new XMLHttpRequest();
            xhr.addEventListener('load', onRegisterResponse);
            xhr.addEventListener('error', onNetworkError);
            xhr.open('POST', 'register');
            xhr.send(params);
        }

        function onRegisterResponse() {
            if (this.status === OK) {
                const user = JSON.parse(this.responseText);
                alert('Thank you for registering  !')
                showContents(['login-content']);
            } else {
                onOtherResponse(document.getElementById('register-form'), this);
            }
        }

        function onOtherResponse(targetEl, xhr) {
            if (xhr.status === NOT_FOUND) {
                newError(targetEl, 'Not found');
                console.error(xhr);
            } else {
                const json = JSON.parse(xhr.responseText);
                if (xhr.status === INTERNAL_SERVER_ERROR) {
                    newError(targetEl, `Server error: ${json.message}`);
                } else if (xhr.status === UNAUTHORIZED || xhr.status === BAD_REQUEST) {
                    newError(targetEl, json.message);
                } else {
                    newError(targetEl, `Unknown error: ${json.message}`);
                }
            }
        }

        function newError(targetEl, message) {
            newMessage(targetEl, 'error', message);
        }

        function newMessage(targetEl, cssClass, message) {
            clearMessages();

            const pEl = document.createElement('p');
            pEl.classList.add('message');
            pEl.classList.add(cssClass);
            pEl.textContent = message;

            targetEl.appendChild(pEl);
        }

        function clearMessages() {
            const messageEls = document.getElementsByClassName('message');
            for (let i = 0; i < messageEls.length; i++) {
                const messageEl = messageEls[i];
                messageEl.remove();
            }
        }

        function onNetworkError(response) {
            document.body.remove();
            const bodyEl = document.createElement('body');
            document.appendChild(bodyEl);
            newError(bodyEl, 'Network error, please try reloading the page');
        }


        function onLoginResponse() {
            if (this.status === OK) {
                const user = JSON.parse(this.responseText);
                setAuthorization(user);
                showContents('welcome-content')
                // onProfileLoad(user);
            } else {
                onOtherResponse(document.getElementById('login-form'), this);
            }
        }

        function onLoginButtonClicked() {
            const loginFormEl = document.forms['login-form'];

            const emailInputEl = loginFormEl.querySelector('input[name="email"]');
            const passwordInputEl = loginFormEl.querySelector('input[name="password"]');

            const email = emailInputEl.value;
            const password = passwordInputEl.value;

            const params = new URLSearchParams();
            params.append('email', email);
            params.append('password', password);

            const xhr = new XMLHttpRequest();
            xhr.addEventListener('load', onLoginResponse);
            xhr.addEventListener('error', onNetworkError);
            xhr.open('POST', 'login');

            xhr.send(params);
        }


        function setAuthorization(user) {
            return localStorage.setItem('user', JSON.stringify(user));
        }

        function loadGames() {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', 'games');
            xhr.onload = function () {
                if (this.status == OK) {
                    let games = JSON.parse(this.responseText);
                    const tbodyEl = document.createElement('tbody');
                    tbodyEl.setAttribute('class', 'buy-cells');


                    for (let i = 0; i < games.length; i++) {
                        const game = games[i];

                        const imageTdEl = document.createElement('td');
                        imageTdEl.classList.add('default-cell');
                        imageTdEl.innerHTML = '<img src="' + game.imageUrl + '" width="150" height="150">';

                        const nameTdEl = document.createElement('td');
                        nameTdEl.classList.add('default-cell');
                        nameTdEl.textContent = game.name;

                        const platformTdEl = document.createElement('td');
                        platformTdEl.classList.add('default-cell');
                        platformTdEl.textContent = game.platform;

                        const priceTdEl = document.createElement('td');
                        priceTdEl.classList.add('default-cell');
                        priceTdEl.textContent = game.price;

                        const buttonBuyEl = document.createElement('button');
                        buttonBuyEl.textContent = "Buy game";
                        buttonBuyEl.setAttribute('id', 'buy-game' + game.id);

                        buttonBuyEl.dataset.gameBuyId = game.id;
                        buttonBuyEl.addEventListener('click', onBuyButtonClicked);

                        buttonBuyEl.dataset.gamePrice = game.price;

                        const buttonOneTdEl = document.createElement('td');
                        buttonOneTdEl.appendChild(buttonBuyEl);
                        buttonOneTdEl.setAttribute('id', 'buy-game-' + game.id);

                        const trEl = document.createElement('tr');
                        trEl.setAttribute('id', 'row-game-id-' + game.id);
                        trEl.appendChild(imageTdEl);
                        trEl.appendChild(nameTdEl);
                        trEl.appendChild(platformTdEl);
                        trEl.appendChild(priceTdEl);
                        if (getCurrentUser().role === 'REGISTERED') {
                            trEl.appendChild(buttonOneTdEl);
                        }
                        tbodyEl.appendChild(trEl);
                        gamesContentDivEl.innerHTML = '';
                        gamesContentDivEl.appendChild(tbodyEl);
                    }


                    //return tbodyEl;





                    /*          if (this.status == OK) {
                                  let games = JSON.parse(this.responseText);
                                  let output = '';
                                  for (var i in games) {
                                      output += '<div id="games-content" class="content games">' +
                                          '<img src="' + games[i].imageUrl + '" width="150" height="150">' +
                                          '<ul>' +
                                          '<li>Name: ' + games[i].name + '</li>' +
                                          '<li>Platform: ' + games[i].platform + '</li>' +
                                          '<li>Price: ' + games[i].price + '</li>' +
                                          '<li><button id="buy-game" name="buy-game" content="gameId' + games[i].id + '">Buy game</button> </li>' +
                                          '</ul>' +
                                          '</div>';
                                  }
                                //  document.getElementById('games-content').innerHTML = output;
                              } */
                }
            }
            showContents(['welcome-content', 'games-content']);
            xhr.send();

        }

        function backToWelcomeScreen() {
            onLoginButtonClicked();
        }

        function onProfileButtonClicked() {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', 'protected/personalInfos');
            xhr.onload = function () {
                if (this.status === OK) {
                    let personalInfos = JSON.parse(this.responseText);
                    let output = '<div id="sub-profile-content" class="content profile">' +
                        '<ul>' +
                        '<li>Name: ' + personalInfos.name + '</li>' +
                        '<li>Address: ' + personalInfos.address + '</li>' +
                        '<li>Phone number: ' + personalInfos.phoneNumber + '</li>' +
                        '</ul>' +
                        '</div>';
                    document.getElementById('profile-content').innerHTML = output;
                }
            }
            showContents(['welcome-content', 'profile-content', 'change-profile-infos-content','add-to-balance-content']);
            xhr.send();
        }

        function onChangeProfileInfosButtonClicked() {
            const changeProfilInfosEl = document.forms['change-profile-infos-form'];

            const nameInputEl = changeProfilInfosEl.querySelector('input[name="name"]');
            const addressInputEl = changeProfilInfosEl.querySelector('input[name="address"]');
            const phoneNumberInputEl = changeProfilInfosEl.querySelector('input[name="phoneNumber"]');


            const name = nameInputEl.value;
            const address = addressInputEl.value;
            const phoneNumber = phoneNumberInputEl.value;

            const params = new URLSearchParams();
            params.append('name', name);
            params.append('address', address);
            params.append('phoneNumber', phoneNumber);

            const xhr = new XMLHttpRequest();
            xhr.addEventListener('load', onChangeProfileInfosRespond);
            xhr.addEventListener('error', onNetworkError);
            xhr.open('POST', 'protected/personalInfos');
            xhr.send(params);
        }

        function onChangeProfileInfosRespond() {
            if (this.status === OK) {
                const personalInfos = JSON.parse(this.responseText);
                alert('Profile infos updated !');
                showContents(['welcome-content']);
            } //else {
            // onOtherResponse(document.getElementById('register-form'), this);
            //}
        }

        function onLogoutButtonClicked() {
            const xhr = new XMLHttpRequest();
            xhr.addEventListener('load', onLogoutResponse);
            xhr.addEventListener('error', onNetworkError);
            xhr.open('GET', 'logout');
            xhr.send();
        }

        function onLogoutResponse() {
            if (this.status === OK) {
                const response = JSON.parse(this.responseText);
                alert(response.message);
                onLoad();
            } else {
                const contentEls = document.getElementsByClassName('content');
                for (let i = 0; i < contentEls.length; i++) {
                    const contentEl = contentEls[i];
                    if (contentEl.style.display === 'block') {
                        onOtherResponse(contentEl);
                    }
                }
            }
        }


    function onBuyButtonClicked() {
        const gameBuyId = this.dataset.gameBuyId;

        const params = new URLSearchParams();
        params.append('gameBuyId', gameBuyId);

        const xhr = new XMLHttpRequest();
        xhr.addEventListener('load', onGameBuyResponse);
        xhr.addEventListener('error', onNetworkError);
        xhr.open('POST', 'protected/purchases');

        xhr.send(params);
    }

    function onGameBuyResponse() {
        if (this.status === OK) {
            const message = JSON.parse(this.responseText);
            alert(message.message);
            showContents(['welcome-content', 'games-content']);
        }else if (this.status === INTERNAL_SERVER_ERROR){
            const json = JSON.parse(this.responseText);{
                alert(`Already in purchase list ! \nServer error: ${json.message}`);
            }
        }
        else {
        onOtherResponse(gamesContentDivEl, this);
        }
    }

    function onAddToBalanceButtonClicked() {
        const addToBalanceFormEl = document.forms['add-to-balance-form'];

        const balanceInputEl = addToBalanceFormEl.querySelector('input[name="balance"]');

        const balance = balanceInputEl.value;

        const params = new URLSearchParams();
        params.append('balance', balance);

        const xhr = new XMLHttpRequest();
        xhr.addEventListener('load', onAddToBalanceRespond);
        xhr.addEventListener('error', onNetworkError);
        xhr.open('POST', 'protected/users');
        xhr.send(params);
    }

    function onAddToBalanceRespond() {
        if (this.status === OK) {
            const balance = JSON.parse(this.responseText);
            alert('Added to balance !')
            showContents(['welcome-content']);
        } else {
         onOtherResponse(document.getElementById('register-form'), this);
        }
    }

    function onActualBalanceButtonClicked() {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', 'protected/profile');
        xhr.onload = function () {
            if (this.status === OK) {
                let user = JSON.parse(this.responseText);
                alert('Your actual balance is : ' + user.balance);
            }
        }
        xhr.send();
    }

    function onMyPurchasesButtonClicked() {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', 'protected/users');
        xhr.onload = function () {
            if (this.status === OK) {
                let games = JSON.parse(this.responseText);
                let output = '';
                for (var i in games) {
                    output += '<div id="my-purchases-content" class="content">' +
                        '<ul>' +
                        '<li><img src="' + games[i].imageUrl + '" width="150" height="150"></li>' +
                        '<li>Name: ' + games[i].name + '</li>' +
                        '<li>Platform: ' + games[i].platform + '</li>' +
                        '</ul>' +
                        '</div>';
                }
                document.getElementById('my-purchases-content').innerHTML = output;
            }
        }
        showContents(['welcome-content', 'my-purchases-content']);
        xhr.send();
    }

</script>

</body>
</html>
